"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const h={above:{index:function(r,t){return r.above(t)},filter:function(r,t){return r>t}},aboveOrEqual:{index:function(r,t){return r.aboveOrEqual(t)},filter:function(r,t){return r>=t}},anyOf:{index:function(r,t){return r.anyOf(t)},filter:function(r,t){return t.includes(r)}},anyOfIgnoreCase:{index:function(r,t){return r.anyOfIgnoreCase(t)},filter:function(r,t){return t.find(e=>String(e).toLowerCase()==r)}},below:{index:function(r,t){return r.below(t)},filter:function(r,t){return r<t}},belowOrEqual:{index:function(r,t){return r.belowOrEqual(t)},filter:function(r,t){return r<=t}},between:{index:function(r,[t,e,n,s]){return r.between(t,e,n,s)},filter:function(r,[t,e,n,s]){let i=n?t-1:t,o=s?e+1:e;return r>i&&r<o}},equals:{index:function(r,t){return r.equals(t)},filter:function(r,t){return r===t}},equalsIgnoreCase:{index:function(r,t){return r.equalsIgnoreCase(t)},filter:function(r,t){return String(r).toLowerCase()===String(t).toLowerCase()}},noneOf:{index:function(r,t){return r.noneOf(t)},filter:function(r,t){return!t.includes(r)}},noneOfIgnoreCase:{index:function(r,t){return r.anyOfIgnoreCase(t)},filter:function(r,t){return!t.find(e=>String(e).toLowerCase()==String(r).toLowerCase())}},notEqual:{index:function(r,t){return r.notEqual(t)},filter:function(r,t){return r!==t}},startsWith:{index:function(r,t){return r.startsWith(t)},filter:function(r,t){return String(r).startsWith(t)}},startsWithIgnoreCase:{index:function(r,t){return r.startsWithIgnoreCase(t)},filter:function(r,t){return String(r).toLowerCase().startsWith(String(t).toLowerCase())}},startsWithAnyOf:{index:function(r,t){return r.startsWithAnyOf(t)},filter:function(r,t){return t.find(e=>String(r).startsWith(e))}},startsWithAnyOfIgnoreCase:{index:function(r,t){return r.startsWithAnyOfIgnoreCase(t)},filter:function(r,t){return t.find(e=>String(r).toLowerCase().startsWith(String(e).toLowerCase()))}}},d=function(r,t,e){return n=>t.call(n,n[r],e)},b=function(r,t,e){return()=>t.call(r,r,e)};class g{constructor(t){this._primaryQueryAdded=!1,this._filters=[],this._index=0,this._sortDesc=!1,this._tableStore=t}offset(t){return this._offset=t,this}limit(t){return this._limit=t,this}sortBy(t,e=!1){return this._sortBy=t,this._sortDesc=e,this}reverse(){return this._sortDesc=!0,this}where(t){return this._index===0&&(this._whereBulder=this._tableStore.where(t)),this._currentKeyPath=t,this}and(t){if(this._index===0)throw new Error("Can not use .and() with first where condition");return this.where(t)}above(t){return this._processFilter("above",t)}aboveOrEqual(t){return this._processFilter("aboveOrEqual",t)}anyOf(t){return this._processFilter("anyOf",t)}anyOfIgnoreCase(t){return this._processFilter("anyOfIgnoreCase",t)}below(t){return this._processFilter("below",t)}belowOrEqual(t){return this._processFilter("belowOrEqual",t)}between(t,e,n=!0,s=!0){return this._processFilter("between",[t,e,n,s])}equals(t){return this._processFilter("equals",t)}equalsIgnoreCase(t){return this._processFilter("equalsIgnoreCase",t)}like(t){var e=t&&t.toUpperCase(),n=this._currentKeyPath;return this.filter(s=>s[n]&&s[n].toUpperCase().indexOf(e)!==-1)}in(t){return this._processFilter("anyOf",t)}noneOf(t){return this._processFilter("noneOf",t)}notEqual(t){return this._processFilter("notEqual",t)}startsWith(t){return this._processFilter("startsWith",t)}startsWithAnyOf(t){return this._processFilter("startsWithAnyOf",t)}startsWithAnyOfIgnoreCase(t){return this._processFilter("startsWithAnyOfIgnoreCase",t)}startsWithIgnoreCase(t){return this._processFilter("startsWithIgnoreCase",t)}filter(t){return typeof t=="function"&&this._filters.push(t),this}count(){let t=this.build();return t.sorted?t.collection.then(e=>e.length):t.collection.count()}first(){let t=this.build();return t.sorted?t.collection.then(e=>e[0]):t.collection.first()}last(){let t=this.build();return t.sorted?t.collection.then(e=>e[e.length-1]):t.collection.last()}fetch(){return this.all()}all(){let t=this.build();return t.sorted?t.collection.then(e=>e):t.collection.toArray()}delete(){return this.build().delete()}build(){var n;let t,e={sorted:!1,collection:void 0};return this._collection?t=(n=this._collection)==null?void 0:n.call(this):this._whereBulder?t=this._whereBulder:t=this._tableStore,this._filters.length&&(this._index===0&&(t=this._tableStore),t=t.filter(s=>this._filters.findIndex(o=>!o(s))===-1)),this._offset&&(t=t.offset(this._offset)),this._limit&&(t=t.limit(this._limit)),e.collection=t,this._sortBy&&(this._sortDesc&&(t=t.reverse()),e.collection=t.sortBy(this._sortBy),e.sorted=!0),e}_processFilter(t,e){let n=h[t];if(!n)throw new Error("Invalid filter: "+t);return this._index===0?this._collection=b(this._whereBulder,n.index,e):this._filters.push(d(this._currentKeyPath,n.filter,e)),this._index++,this}}let f={};const c=class c{constructor(t={}){this.populate(t)}static get connection(){return this._connection}populate(t){const e=this;for(let n in t)typeof t[n]!="function"&&(e[n]=t[n]);return this}_beforeSave(){}_afterSave(){}static create(t){var e=this.getTableConnection();let n=new this;n.populate(t),n._beforeSave(),n.hasOwnProperty("created")&&(n.created=new Date);let s=this._getSaveData(n,t);return e.put(s).then(i=>(n.id=i,this.setLastInsert(i),n._afterSave(),n))}static _getSaveData(t,e){let n={};return Object.keys(t).map(i=>n[i]=t[i]),n}save(t){const e=this.constructor;var n=e.getTableConnection();let s,i;return this._beforeSave(),this.id?(i=e._getSaveData(this,t),s=n.update(this.id,this)):(this.hasOwnProperty("created")&&(this.created=new Date),i=e._getSaveData(this,t),delete i.id,s=n.add(i),s.then(o=>{this.id=o,e.setLastInsert(o)})),this._afterSave(),s}delete(){var t=this.constructor.getTableConnection();return t.delete(this.id)}static _where(t,e){let n=t;if(e)for(let s in e)n=t.where(s).equals(e[s]);return n}static async find(t){var e=this.getTableConnection();return e.get(t)}static first(t){let e=this.getQueryBuilder();return this._where(e,t),e.first()}static last(t){let e=this.getQueryBuilder();return this._where(e,t),e.last()}static count(t){var e=this.getQueryBuilder();return this._where(e,t),e.count()}static countIn(t,e,n){var s=this.getTableConnection();let i=s.where(t).anyOf(e);return n&&(i=i.and(n)),i.count()}static fetch(t,e,n,s,i){if(n&&e){var o=(n-1)*e;t.offset(o)}return e&&t.limit(e),s&&t.sortBy(s,i),t.all()}static all(t,e,n,s,i){let o=this.getQueryBuilder();return t&&(o=this._where(o,t)),this.fetch(o,e,n,s,i)}static filter(t){return this.getQueryBuilder().filter(t)}static where(t){const e=this.getQueryBuilder();return e.where(t),e}static whereIn(t,e){return this.getQueryBuilder().where(t).anyOf(e).all()}static whereNotIn(t,e){return this.getQueryBuilder().where(t).noneOf(e).all()}static insertAll(t){var e=this.getTableConnection();let n=e==null?void 0:e.bulkPut(t);return n==null||n.then(s=>{this.setLastInsert(s)}),n}static updateAll(t){var e=this.getTableConnection();return e.bulkPut(t)}static deleteAll(t){var e=this.getTableConnection();return e.bulkDelete(t)}static truncate(){var t=this.getTableConnection();return t.clear()}static setLastInsert(t){var e=this.getTableName();f[e]=t}static getLastInsert(){var t=this.getTableName();return f[t]}static setTableConnection(t){this._connection=t}static getTableConnection(){if(!this._connection)throw"Table connection is not set. Do this with the setTableConnection method";return this._connection}static getQueryBuilder(){const t=this.getTableConnection();return new g(t)}static query(){return this.getQueryBuilder()}static getSchema(){return[]}static getColumns(){let t=this.getTableConnection();if(!t)return[];let e=[t.schema.primKey.name];return t.schema.indexes.map(n=>{n.compound||e.push(n.name)}),e}static setTableName(t){this.tableName=t}static getTableName(){return this.tableName}static getNumberValue(t){return typeof t=="number"?t:typeof t=="boolean"?t?1:0:typeof t=="string"?Number(t):isNaN(t)?0:Number(t)}};c.tableName="";let u=c;const _=(r,t)=>{var e={},n={},s={};for(let i of t){const o=i.getTableName();let a=i.getSchema();Array.isArray(a)&&a.map(l=>{if(!l.version||!l.columns){console.warn("Invalid schema configuraiont: ",i.getTableName(),l);return}e[l.version]||(e[l.version]={},n[l.version]=[]),e[l.version][o]=l.columns,s[o]=l.columns,typeof l.upgrade=="function"&&n[l.version].push(l.upgrade)})}for(let i in e){for(let a of t){const l=a.getTableName();e[i].hasOwnProperty(l)&&(e[i][l]=s[l])}r.version(i).stores(e[i]).upgrade(function(){n[i].map(a=>{a==null||a.call(null,r)})})}for(let i of t){const o=i.getTableName();i.setTableConnection(r[o]),i.getTableConnection().mapToClass(i)}};exports.Model=u;exports.setup=_;
